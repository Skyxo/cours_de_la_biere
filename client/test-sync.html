<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Synchronisation</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .client { 
            border: 2px solid #007bff; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            background: #f8f9fa;
        }
        .timer { 
            font-size: 2em; 
            font-weight: bold; 
            color: #007bff; 
            text-align: center;
            margin: 10px 0;
        }
        .status { margin: 5px 0; }
        .sync { color: #28a745; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <h1>ðŸ§ª Test de Synchronisation Multi-Clients</h1>
    <p>Cette page simule plusieurs clients pour tester la synchronisation du timer.</p>
    
    <div class="client">
        <h3>ðŸ“º Client 1 - Projecteur</h3>
        <div class="timer" id="timer1">--</div>
        <div class="status" id="status1">ðŸ”„ Initialisation...</div>
    </div>
    
    <div class="client">
        <h3>ðŸ“± Client 2 - TÃ©lÃ©phone Barman 1</h3>
        <div class="timer" id="timer2">--</div>
        <div class="status" id="status2">ðŸ”„ Initialisation...</div>
    </div>
    
    <div class="client">
        <h3>ðŸ“± Client 3 - TÃ©lÃ©phone Barman 2</h3>
        <div class="timer" id="timer3">--</div>
        <div class="status" id="status3">ðŸ”„ Initialisation...</div>
    </div>
    
    <div style="margin-top: 20px; text-align: center;">
        <button onclick="forceSync()" style="padding: 10px 20px; font-size: 1.1em;">
            ðŸ”„ Forcer la synchronisation de tous les clients
        </button>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let clients = [1, 2, 3];
        let timers = {};
        
        // Simuler chaque client avec un lÃ©ger dÃ©calage
        clients.forEach((clientId, index) => {
            setTimeout(() => {
                startClient(clientId);
            }, index * 200); // DÃ©calage de 200ms entre chaque client
        });
        
        async function startClient(clientId) {
            const timerElement = document.getElementById(`timer${clientId}`);
            const statusElement = document.getElementById(`status${clientId}`);
            
            let countdown = 10;
            let serverSync = null;
            
            // Fonction de synchronisation avec le serveur
            async function syncWithServer() {
                try {
                    const response = await fetch(`${API_BASE}/sync/timer`);
                    const data = await response.json();
                    
                    serverSync = data;
                    
                    // Calculer le temps restant avec compensation rÃ©seau
                    const now = new Date();
                    const serverTime = new Date(data.server_time);
                    const timeDiff = now - serverTime;
                    const adjustedRemaining = data.timer_remaining_ms - timeDiff;
                    
                    countdown = Math.ceil(Math.max(0, adjustedRemaining) / 1000);
                    
                    if (countdown <= 0) {
                        countdown = Math.ceil(data.interval_ms / 1000);
                    }
                    
                    statusElement.innerHTML = `<span class="sync">ðŸŸ¢ SynchronisÃ© (${data.interval_ms/1000}s)</span>`;
                    statusElement.className = 'status sync';
                    
                    return true;
                } catch (error) {
                    statusElement.innerHTML = `<span class="error">ðŸ”´ Erreur: ${error.message}</span>`;
                    statusElement.className = 'status error';
                    return false;
                }
            }
            
            // Fonction de mise Ã  jour du timer
            function updateTimer() {
                if (serverSync) {
                    const now = new Date();
                    const serverTime = new Date(serverSync.server_time);
                    const timeDiff = now - serverTime;
                    const adjustedRemaining = serverSync.timer_remaining_ms - timeDiff;
                    
                    countdown = Math.ceil(Math.max(0, adjustedRemaining) / 1000);
                    
                    if (countdown <= 0) {
                        syncWithServer();
                        return;
                    }
                } else {
                    if (countdown <= 1) {
                        countdown = 10; // Fallback
                    } else {
                        countdown--;
                    }
                }
                
                timerElement.textContent = countdown;
            }
            
            // DÃ©marrer le client
            syncWithServer().then(() => {
                timers[clientId] = setInterval(updateTimer, 1000);
                
                // Resynchroniser toutes les 30 secondes
                setInterval(syncWithServer, 30000);
            });
        }
        
        // Fonction pour forcer la synchronisation
        async function forceSync() {
            console.log('ðŸ”„ Force synchronisation...');
            
            for (let clientId of clients) {
                const statusElement = document.getElementById(`status${clientId}`);
                statusElement.innerHTML = 'ðŸ”„ Resynchronisation...';
                
                try {
                    const response = await fetch(`${API_BASE}/sync/timer`);
                    const data = await response.json();
                    
                    const now = new Date();
                    const serverTime = new Date(data.server_time);
                    const timeDiff = now - serverTime;
                    const adjustedRemaining = data.timer_remaining_ms - timeDiff;
                    
                    let countdown = Math.ceil(Math.max(0, adjustedRemaining) / 1000);
                    if (countdown <= 0) {
                        countdown = Math.ceil(data.interval_ms / 1000);
                    }
                    
                    document.getElementById(`timer${clientId}`).textContent = countdown;
                    statusElement.innerHTML = `<span class="sync">ðŸŸ¢ ResynchronisÃ©!</span>`;
                    
                } catch (error) {
                    statusElement.innerHTML = `<span class="error">ðŸ”´ Erreur: ${error.message}</span>`;
                }
            }
        }
        
        // Afficher les informations de debug
        setInterval(async () => {
            try {
                const response = await fetch(`${API_BASE}/sync/timer`);
                const data = await response.json();
                console.log(`Timer: ${Math.ceil(data.timer_remaining_ms/1000)}s restantes`);
            } catch (e) {
                console.log('Erreur sync:', e);
            }
        }, 5000);
    </script>
</body>
</html>
